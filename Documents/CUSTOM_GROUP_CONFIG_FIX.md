# 自訂分組配置修復

## 🐛 問題描述

### 原有邏輯（有問題）

```typescript
if (suggestedConfigs.length > 0) {
  // 顯示推薦方案
  // 顯示自訂分組 ← 包在條件內
} else {
  // 只顯示警告，沒有自訂選項 ❌
}
```

**問題**：

- 當無推薦方案時，自訂分組選項被隱藏
- 用戶無法手動設定分組
- 只能接受降級為純淘汰，沒有選擇

### 使用者遇到的情況

```
參賽 5 人 + 小組賽配置
→ 系統無法推薦合適方案（5 人難以平衡分組）
→ UI 只顯示警告：「將自動改用純淘汰賽」
→ 無法手動設定分組
→ 用戶想要 2 組（2,3 人）→ 取前 2 → 4 強
→ 但沒有輸入框可以設定！
```

## 解決方案：總是顯示自訂分組

### 新邏輯

```typescript
if (participants.length < 4) {
  // 人數太少，顯示降級警告
} else {
  // 顯示推薦方案（如果有）
  // + 總是顯示自訂分組
}
```

**改進**：

- 自訂分組總是可見（人數 >= 4 時）
- 有推薦方案：可選擇推薦或自訂
- 無推薦方案：可以手動設定
- 提供完整的用戶控制權

## 🎨 UI 改進

### 情況 1：有推薦方案（正常）

```
┌────────────────────────────────────┐
│ 分組方案                           │
├────────────────────────────────────┤
│ 方案 A（推薦）✓                   │
│ 4 組循環賽，各取前 2 名 → 8 強    │
│ 總場次：26 場                      │
├────────────────────────────────────┤
│ 方案 B                             │
│ 5 組循環賽，各取第 1 名 + 3 個     │
│ 最佳第 2 名 → 8 強                │
│ 總場次：23 場                      │
├────────────────────────────────────┤
│ === 自訂分組 ===                   │
│                                    │
│ 分組數: [4] 每組取前: [2] [套用]  │
└────────────────────────────────────┘
```

### 情況 2：無推薦方案（修復後）⭐

```
┌────────────────────────────────────┐
│ 分組方案                           │
├────────────────────────────────────┤
│ === 手動設定分組 ===               │
│                                    │
│ 系統無法自動推薦方案，          │
│    請手動設定分組參數。            │
│                                    │
│ 分組數: [2] 每組取前: [2] [套用]  │
│                                    │
│ ✓ 已套用自訂配置：                │
│   2 組，每組取前 2 名              │
└────────────────────────────────────┘
```

### 情況 3：人數 < 4（降級）

```
┌────────────────────────────────────┐
│ 分組方案                           │
├────────────────────────────────────┤
│ 參賽者人數不足                 │
│                                    │
│ 小組賽至少需要 4 位參賽者，        │
│ 目前僅有 3 位。                    │
│                                    │
│ 點擊「發布賽程」時，系統將自動     │
│ 改用純淘汰賽。                     │
│                                    │
│ 📊 預計賽制：3 人純淘汰賽          │
│ 📊 預計場次：2 場                  │
└────────────────────────────────────┘
```

## 🎯 使用場景

### 場景 1：推薦方案存在

```
參賽 20 人 → 有推薦方案 A、B

選項 1：使用推薦方案 A
  → 點擊方案 A → 發布

選項 2：使用自訂配置
  → 調整「分組數: 5」「每組取前: 1」
  → 點擊「套用」
  → 發布
```

### 場景 2：推薦方案不存在（修復前卡住）⭐

```
參賽 5 人 → 無推薦方案

修復前：
  只顯示警告
  無法手動設定
  只能接受降級

修復後：
   顯示「手動設定分組」
   可以輸入：分組數 2，每組取前 2
   點擊「套用」
   系統驗證並生成配置
   可以發布
```

### 場景 3：人數太少（< 4）

```
參賽 3 人 → 無法分組

顯示：
  將自動改用純淘汰賽

不顯示：
  自訂分組選項（因為沒意義）

操作：
  點擊「發布賽程」→ 自動降級
```

## 🔧 技術實現

### 條件顯示邏輯

```typescript
{
  participants.length < 4 ? (
    // 情況 A：人數太少（< 4）
    <Warning>將自動降級</Warning>
  ) : (
    // 情況 B：人數足夠（>= 4）
    <>
      {suggestedConfigs.length > 0 && (
        // B1: 顯示推薦方案（如果有）
        <ConfigsList />
      )}

      {/* B2: 總是顯示自訂分組  */}
      <CustomConfig />
    </>
  );
}
```

### 驗證邏輯

```typescript
const handleCustomConfig = () => {
  // 驗證配置是否合理
  const validation = validateGroupConfig(
    participants.length,
    customGroups,
    customAdvance
  );

  if (!validation.valid) {
    setError(validation.error);  // 顯示錯誤
    return;
  }

  // 創建自訂配置
  const customConfigObj = {
    totalGroups: customGroups,
    teamsPerGroup: [...],
    advancePerGroup: customAdvance,
    knockoutSize: validation.knockoutSize,
    description: `自訂：${customGroups} 組，每組取前 ${customAdvance} 名`,
  };

  setSelectedConfig(customConfigObj);  // 設為選中的配置
  setError("");
};
```

### 發布時的處理

```typescript
const handlePublish = async () => {
  if (suggestedConfigs.length === 0 && !selectedConfig) {
    // 既無推薦方案，也沒有套用自訂配置 → 降級
    await generateKnockoutOnly(...);
  } else if (selectedConfig) {
    // 有選中的配置（推薦或自訂）→ 使用配置
    await generateGroupThenKnockout(selectedConfig);
  }
};
```

## 📊 配置驗證規則

### 驗證項目

1. **分組數** (totalGroups)

   - 最小：2 組
   - 最大：8 組
   - 不能超過參賽者數量的一半

2. **每組取前** (advancePerGroup)

   - 最小：1 名
   - 最大：4 名
   - 不能大於等於最小組人數

3. **晉級總數** (knockoutSize)
   - 必須是 2 的次方（4, 8, 16, 32...）
   - 計算：totalGroups × advancePerGroup

### 錯誤訊息

```
分組數太少：「至少需要 2 組」
分組數太多：「分組數過多」
晉級人數不合理：「晉級人數不能大於等於最小組人數」
晉級總數不合法：「晉級總數 (6) 必須為 2 的次方」
```

## 🎯 測試案例

### 測試 1：5 人無推薦方案

```
參賽：5 人
配置：小組賽+淘汰賽

UI 顯示：
  手動設定分組
  系統無法自動推薦方案，請手動設定

操作：
  分組數：2
  每組取前：2
  點擊「套用」

驗證：
  2 組 x 2 名 = 4 強 ✓ （2 的次方）
  每組 2-3 人 ✓ （合理）

結果：
  ✓ 已套用自訂配置：2 組，每組取前 2 名

發布：
   成功生成 2 組小組賽 + 4 強淘汰賽
```

### 測試 2：6 人無推薦方案

```
參賽：6 人

操作：
  分組數：2
  每組取前：1
  點擊「套用」

驗證：
  2 組 x 1 名 = 2 強 ✓ （決賽）
  每組 3 人 ✓

結果：
  ✓ 已套用自訂配置：2 組，每組取前 1 名

發布：
   6 人分 2 組循環 + 決賽
```

### 測試 3：錯誤配置

```
參賽：8 人

操作：
  分組數：2
  每組取前：3
  點擊「套用」

驗證：
  2 組 x 3 名 = 6 強 ✗ （不是 2 的次方）

結果：
  顯示錯誤：「晉級總數 (6) 必須為 2 的次方」
```

## 📋 修改清單

### 修改文件

- `CategoryPublisher.tsx`

- 調整條件邏輯
- 自訂分組總是顯示（>= 4 人時）
- 添加提示文字
- 添加套用成功提示

- `CategoryPublisher.module.scss`
- 添加提示樣式（customHint）
- 添加預覽樣式（customPreview）

## 修復效果

| 情況                  | 修復前   | 修復後        |
| --------------------- | -------- | ------------- |
| 有推薦方案            | 正常     | 正常          |
| 無推薦方案（>= 4 人） | 無法設定 | 可手動設定 ⭐ |
| 人數 < 4              | 卡住     | 自動降級      |

### 用戶體驗

**修復前**：

```
5 人 + 無推薦方案
→ 只能看到警告
→ 無法操作
→ 必須接受降級
```

**修復後**：

```
5 人 + 無推薦方案
→ 顯示「手動設定分組」
→  可以自訂分組參數
→  系統驗證配置
→  套用成功
→  發布小組賽
→ 或者接受降級（用戶選擇）
```

## 最佳實踐

### 建議的自訂配置

#### 5 人

```
選項 A：2 組（2,3 人）→ 取前 2 → 4 強
選項 B：接受降級 → 8 強純淘汰（3 BYE）
```

#### 6 人

```
選項 A：2 組（3,3 人）→ 取前 2 → 4 強
選項 B：2 組（3,3 人）→ 取前 1 → 決賽
選項 C：接受降級 → 8 強純淘汰（2 BYE）
```

#### 7 人

```
選項 A：2 組（3,4 人）→ 取前 2 → 4 強
選項 B：接受降級 → 8 強純淘汰（1 BYE）
```

### 驗證技巧

**記住公式**：

```
晉級總數 = 分組數 × 每組取前

必須滿足：
1. 晉級總數 = 2^n（2, 4, 8, 16, 32...）
2. 每組人數 >= 3
3. 每組取前 < 每組人數
```

**範例**：

```
10 人，想要 8 強淘汰
→ 需要 8 人晉級
→ 可能配置：
   - 4 組 x 取前 2 = 8 ✓
   - 8 組 x 取前 1 = 8 ✓
   - 2 組 x 取前 4 = 8（但每組只有 5 人，取前 4 太多 ✗）
```

## 🎯 用戶反饋

### 清晰的提示

**有推薦方案時**：

```
標題：「自訂分組」
提示：（無，因為有推薦）
```

**無推薦方案時**：

```
標題：「手動設定分組」
提示：「系統無法自動推薦方案，請手動設定分組參數。」
```

### 即時反饋

**套用成功時**：

```
✓ 已套用自訂配置：2 組，每組取前 2 名
```

**驗證失敗時**：

```
顯示錯誤訊息（在表單上方）
例如：「晉級總數 (6) 必須為 2 的次方」
```

## 📊 完整流程圖

```
參賽者數量判斷
    ├─ < 4 人 → 顯示降級警告（無自訂選項）
    │            可以發布（自動降級）
    │
    └─ >= 4 人 → 嘗試生成推薦方案
        ├─ 有方案 → 顯示推薦方案 + 自訂分組
        │           可以選擇推薦或自訂
        │
        └─ 無方案 → 顯示手動設定分組 ⭐
                    可以自訂參數
                    或接受降級
```

## 測試檢查清單

- [x] 有推薦方案：自訂分組可見
- [x] 無推薦方案：自訂分組可見 ⭐
- [x] 人數 < 4：自訂分組隱藏（合理）
- [x] 修改分組數：可以改動
- [x] 修改取前數：可以改動
- [x] 點擊「套用」：驗證並套用
- [x] 套用成功：顯示綠色提示
- [x] 驗證失敗：顯示錯誤訊息
- [x] 使用自訂配置發布：成功

---

## 🎉 問題已解決

**自訂分組現在總是可用！**

- 有推薦方案：可選擇推薦或自訂
- 無推薦方案：可手動設定 ⭐
- 人數不足：自動降級（合理）
- 驗證完整：防止錯誤配置
- 反饋清晰：用戶知道發生什麼

**完整的用戶控制權 + 智能自動化 = 完美體驗！** 🚀

---

**實施日期**: 2024 年 12 月 21 日  
**問題**: 自訂分組無法改動  
**原因**: 條件判斷包裹錯誤  
**解決**: 調整顯示邏輯，總是可見  
**狀態**: 已修復
