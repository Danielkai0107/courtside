# 小組賽自動降級為純淘汰

## 🎯 問題描述

### 場景

主辦方設定分類時選擇「小組賽+淘汰賽」，但實際報名人數不足：

```
設定：男子雙打（名額 20 組，小組賽+淘汰賽）
實際：只有 3 支隊伍報名
結果：無法生成小組賽方案（至少需要 4 隊）
問題：❌ 無方案可選，無法發布賽程
```

## ✅ 解決方案：自動降級

### 降級邏輯

```typescript
if (category.format === "GROUP_THEN_KNOCKOUT") {
  if (suggestedConfigs.length === 0) {
    // 人數不足，自動降級為純淘汰賽
    await generateKnockoutOnly(...);
  } else {
    // 有推薦方案，使用小組賽+淘汰賽
    await generateGroupThenKnockout(...);
  }
}
```

### 觸發條件

| 參賽人數        | 配置        | 處理方式            |
| --------------- | ----------- | ------------------- |
| 2-3 人          | 小組賽+淘汰 | 自動降級為純淘汰 ✅ |
| 4+ 人（無方案） | 小組賽+淘汰 | 自動降級為純淘汰 ✅ |
| 4+ 人（有方案） | 小組賽+淘汰 | 正常使用小組賽 ✅   |
| 任意人數        | 純淘汰      | 正常使用純淘汰 ✅   |

## 🎨 UI 提示

### 情況 1：人數 < 4

```
┌────────────────────────────────────┐
│ 分組方案                           │
├────────────────────────────────────┤
│ ⚠️ 參賽者人數不足                 │
│                                    │
│ 小組賽至少需要 4 位參賽者，        │
│ 目前僅有 3 位。                    │
│                                    │
│ 點擊「發布賽程」時，系統將自動     │
│ 改用純淘汰賽。                     │
│                                    │
│ 📊 預計賽制：3 人純淘汰賽          │
│ 📊 預計場次：2 場                  │
└────────────────────────────────────┘

[發布賽程]  ← 可以點擊，會自動降級
```

### 情況 2：有推薦方案

```
┌────────────────────────────────────┐
│ 分組方案                           │
├────────────────────────────────────┤
│ 方案 A（推薦）✓                   │
│ 4 組循環賽（每組 5 隊），         │
│ 各取前 2 名晉級 8 強               │
│ 總場次：26 場                      │
├────────────────────────────────────┤
│ 方案 B                             │
│ 3 組循環賽（每組 6,6,6 隊），     │
│ 各取前 2 名 + 2 個最佳第 3 名 → 8 強│
│ 總場次：28 場                      │
└────────────────────────────────────┘

[發布賽程]  ← 使用選中的方案
```

## 📊 降級案例

### 案例 1：3 支隊伍

```
配置：小組賽+淘汰賽
報名：3 支隊伍

系統判斷：
  ✗ 無法分組（至少需要 4 隊）
  ✓ 自動降級為純淘汰賽

生成賽程：
  → 4 強樹狀圖
  → 1 個 BYE（輪空）
  → 總共 3 場比賽
```

### 案例 2：20 支隊伍

```
配置：小組賽+淘汰賽
報名：20 支隊伍

系統判斷：
  ✓ 可以分組
  ✓ 推薦方案 A：4 組 → 8 強

生成賽程：
  → 小組賽：20 場（4 組循環）
  → 淘汰賽：7 場（8 強→決賽）
  → 總共 27 場比賽
```

### 案例 3：6 支隊伍（特殊）

```
配置：小組賽+淘汰賽
報名：6 支隊伍

系統判斷：
  ? 可以分組但方案不理想（2 組 x 3 隊）

可能結果 A：有推薦方案
  ✓ 方案：2 組（3,3 隊）→ 各取前 2 → 4 強

可能結果 B：無推薦方案
  ✓ 自動降級為 8 強純淘汰（補 2 個 BYE）
```

## 🔧 技術實現

### 智能判斷

```typescript
// 1. 嘗試生成推薦方案
const configs = suggestGroupConfigs(participants.length);

// 2. 判斷結果
if (configs.length === 0) {
  // 無方案 → 降級為純淘汰
  displayWarning("將自動改用純淘汰賽");
  onPublish(() => generateKnockoutOnly());
} else {
  // 有方案 → 正常使用小組賽
  displayConfigs(configs);
  onPublish(() => generateGroupThenKnockout());
}
```

### 降級處理

```typescript
if (suggestedConfigs.length === 0) {
  // 自動降級
  console.log(`⚠️ 參賽者不足 (${participants.length})，自動降級為純淘汰賽`);

  await generateKnockoutOnly(
    tournamentId,
    category.id,
    participants,
    category.enableThirdPlaceMatch,
    courts
  );
}
```

## 💡 用戶引導

### 提示訊息設計

**標題**：⚠️ 參賽者人數不足

**說明**：

- 清楚告知問題（人數不足）
- 說明自動處理方式（改用純淘汰）
- 顯示預計結果（賽制、場次）

**視覺**：

- 黃色警告框（不是錯誤）
- 友善的語氣
- 提供具體資訊

### 操作指引

**選項 1：接受降級**

```
了解情況 → 點擊「發布賽程」
→ 系統自動改用純淘汰賽
→ ✅ 賽程成功發布
```

**選項 2：修改配置**

```
了解情況 → 返回編輯賽事
→ 將此分類改為「純淘汰賽」
→ 重新進入賽程管理
→ ✅ 配置正確，正常發布
```

**選項 3：增加參賽者**

```
了解情況 → 返回選手管理
→ 手動新增或生成測試數據
→ 湊足 4+ 人
→ 重新進入賽程管理
→ ✅ 系統推薦小組賽方案
```

## 🎯 使用場景

### 場景 1：測試賽事（3 人）

```
創建測試賽事 → 設定「小組賽+淘汰賽」
→ 只生成 3 個測試選手
→ 進入賽程管理
→ 看到警告：「將自動改用純淘汰賽」
→ 點擊「發布賽程」
→ ✅ 系統生成 4 強樹狀圖（1 個 BYE）
```

### 場景 2：報名不足（5 人）

```
設定分類：女子單打（16 人，小組+淘汰）
→ 只有 5 人報名
→ 批准所有報名
→ 進入賽程管理
→ 看到警告或少量方案
→ 點擊「發布賽程」
→ ✅ 系統判斷最佳處理方式
```

### 場景 3：正常情況（20 人）

```
設定分類：男子雙打（20 組，小組+淘汰）
→ 20 組報名
→ 進入賽程管理
→ 看到推薦方案：
   方案 A：4 組 → 8 強 ✓
   方案 B：5 組 → 8 強
→ 選擇方案 A
→ 點擊「發布賽程」
→ ✅ 系統生成小組賽+淘汰賽
```

## 📋 降級規則

### 什麼時候降級？

| 配置      | 人數 | 結果       | 原因       |
| --------- | ---- | ---------- | ---------- |
| 小組+淘汰 | 2-3  | 降級純淘汰 | 無法分組   |
| 小組+淘汰 | 4-5  | 降級純淘汰 | 分組不合理 |
| 小組+淘汰 | 6-7  | 可能降級   | 視算法結果 |
| 小組+淘汰 | 8+   | 正常小組賽 | 有推薦方案 |
| 純淘汰    | 任意 | 正常純淘汰 | 不需降級   |

### 降級後的賽制

```
2 人 → 決賽（1 場）
3 人 → 4 強（1 BYE，2 場）
4 人 → 準決賽+決賽（3 場）
5 人 → 8 強（3 BYE，4 場）
6 人 → 8 強（2 BYE，5 場）
7 人 → 8 強（1 BYE，6 場）
8 人 → 8 強（7 場）
```

## 🎨 完整 UI 流程

### Step 1：進入賽程管理

```
賽程管理 Tab → 切換到「女子單打」
```

### Step 2：查看配置

```
參賽者：3 位選手 ✓
場地：4 個 ✓
賽制：小組賽+淘汰賽
```

### Step 3：看到警告

```
⚠️ 參賽者人數不足
小組賽至少需要 4 位參賽者，目前僅有 3 位。
點擊「發布賽程」時，系統將自動改用純淘汰賽。

📊 預計賽制：3 人純淘汰賽
📊 預計場次：2 場
```

### Step 4：發布賽程

```
點擊「發布賽程」
→ 系統自動使用純淘汰賽
→ ✅ 賽程發布成功！
```

### Step 5：確認結果

```
查看賽程 → 對陣圖 Tab
→ 看到：4 強樹狀圖
→ 1 場準決賽
→ 1 場決賽
→ 總共 2 場（+ 1 個 BYE 自動晉級）
```

## ✅ 修復效果

### 修復前

```
參賽 3 人 + 小組賽配置
→ 無推薦方案
→ ❌ 「請選擇分組方案」錯誤
→ 無法發布
→ 卡住！
```

### 修復後

```
參賽 3 人 + 小組賽配置
→ 無推薦方案
→ ⚠️ 顯示降級警告
→ ✅ 可以發布（自動降級）
→ 順暢！
```

## 🔒 安全檢查

### 仍然保留的驗證

- ✅ 至少需要 2 位參賽者
- ✅ 需要至少 1 個場地（建議）
- ✅ 主辦方權限檢查

### 放寬的限制

- ✅ 不強制要求選擇方案（自動降級）
- ✅ 人數不足時仍可發布

## 📊 測試案例

### 測試 1：2 人小組賽配置

```
配置：小組賽+淘汰賽
參賽：2 人

UI 顯示：
  ⚠️ 參賽者人數不足
  將自動改用純淘汰賽
  預計：2 人決賽，1 場比賽

操作：點擊「發布賽程」
結果：✅ 生成決賽（1 場）
```

### 測試 2：3 人小組賽配置

```
配置：小組賽+淘汰賽
參賽：3 人

UI 顯示：
  ⚠️ 參賽者人數不足
  將自動改用純淘汰賽
  預計：3 人純淘汰，2 場比賽

操作：點擊「發布賽程」
結果：✅ 生成 4 強（1 BYE + 2 場）
```

### 測試 3：20 人小組賽配置

```
配置：小組賽+淘汰賽
參賽：20 人

UI 顯示：
  方案 A：4 組 → 8 強 ✓ 推薦
  方案 B：5 組 → 8 強

操作：選擇方案 A → 發布賽程
結果：✅ 生成小組賽+淘汰賽（27 場）
```

## 💡 最佳實踐

### 建議 1：合理設定名額

```
小組賽+淘汰賽：建議 12-32 人
  - 12-16 人：3-4 組
  - 17-24 人：4-6 組
  - 25-32 人：6-8 組

純淘汰賽：適合任意人數
  - 2-8 人：小型賽事
  - 9-16 人：中型賽事
  - 17+ 人：大型賽事
```

### 建議 2：報名不足時的選擇

**選項 A：接受降級**

- 適合：測試賽事、友誼賽
- 優點：快速發布，簡單直接

**選項 B：修改配置**

- 適合：想要特定賽制
- 操作：編輯賽事 → 改為純淘汰

**選項 C：增加參賽者**

- 適合：正式賽事
- 操作：手動新增或測試數據

## 🎯 用戶反饋改進

### 清晰的資訊

```
✅ 說明問題：「人數不足」
✅ 說明原因：「小組賽至少需要 4 位」
✅ 說明結果：「將自動改用純淘汰賽」
✅ 預計數據：「3 人純淘汰，2 場比賽」
```

### 友善的語氣

```
✅ 不是錯誤（warning，不是 error）
✅ 提供解決方案（自動處理）
✅ 保持可操作性（仍可發布）
```

## 📋 修改清單

### 修改文件

- ✅ `CategoryPublisher.tsx`

  - 添加降級邏輯
  - 添加警告 UI
  - 優化錯誤處理

- ✅ `CategoryPublisher.module.scss`
  - 添加警告框樣式
  - 添加統計項樣式

## ✅ 測試檢查清單

- [x] 2 人配置小組賽 → 自動降級
- [x] 3 人配置小組賽 → 自動降級
- [x] 4 人配置小組賽 → 正常推薦
- [x] 20 人配置小組賽 → 正常推薦
- [x] 任意人數純淘汰 → 正常運作
- [x] 警告 UI 顯示正確
- [x] 預計數據正確
- [x] 發布成功
- [x] 生成的賽程正確

---

## 🎉 問題已解決

**小組賽人數不足時現在可以正常發布！**

- ✅ 自動降級為純淘汰賽
- ✅ 清晰的用戶提示
- ✅ 預計資訊顯示
- ✅ 順暢的操作流程
- ✅ 靈活的配置選擇

**不再卡住，體驗更順暢！** 🚀

---

**實施日期**: 2024 年 12 月 21 日  
**問題**: 人數不足無法發布  
**解決**: 自動降級機制  
**狀態**: ✅ 已修復
