# å ±åèˆ‡ç™¼å¸ƒè³½ç¨‹æµç¨‹èªªæ˜

## é‡è¦ï¼šæˆªæ­¢å ±åä¸æœƒè‡ªå‹•ç™¼å¸ƒè³½ç¨‹

### æ­£ç¢ºçš„æµç¨‹

```
1. å»ºç«‹è³½äº‹ï¼ˆDRAFTï¼‰
   â””â”€ ç”Ÿæˆä½”ä½ç¬¦ Matchï¼ˆisPlaceholder: trueï¼‰
   â””â”€ é¸æ‰‹å¯ä»¥åœ¨ CategoryDetail çœ‹åˆ°é è¦½

2. é–‹æ”¾å ±åï¼ˆREGISTRATION_OPENï¼‰
   â””â”€ é¸æ‰‹é–‹å§‹å ±å
   â””â”€ ä¸»è¾¦æ–¹åœ¨ã€Œé¸æ‰‹ç®¡ç†ã€Tab å¯©æ ¸

3. æˆªæ­¢å ±åï¼ˆREGISTRATION_CLOSEDï¼‰â­
   â””â”€ åªæ”¹è®Šç‹€æ…‹
   â””â”€ ä¸æœƒè‡ªå‹•ç™¼å¸ƒè³½ç¨‹
   â””â”€ ä¸æœƒè‡ªå‹•åˆ†é…é¸æ‰‹
   â””â”€ ä½”ä½ç¬¦ Match ä¿æŒä¸è®Š

4. æ‰‹å‹•ç™¼å¸ƒè³½ç¨‹ï¼ˆåœ¨ã€Œè³½ç¨‹ç®¡ç†ã€Tabï¼‰â­
   â””â”€ ä¸»è¾¦æ–¹é€²å…¥ã€Œè³½ç¨‹ç®¡ç†ã€Tab
   â””â”€ é»æ“Šã€Œç™¼å¸ƒè³½ç¨‹ã€
   â””â”€ æ­¤æ™‚æ‰åˆ†é…é¸æ‰‹åˆ° Match
   â””â”€ isPlaceholder è®Šç‚º false
   â””â”€ ç‹€æ…‹è‡ªå‹•è½‰ç‚º ONGOING
```

### ç‚ºä»€éº¼è¦åˆ†é–‹ï¼Ÿ

**å¥½è™•ï¼š**

- ä¸»è¾¦æ–¹å¯ä»¥åœ¨æˆªæ­¢å ±åå¾Œæª¢æŸ¥äººæ•¸
- å¯ä»¥æ±ºå®šæ˜¯å¦å»¶é•·å ±å
- å¯ä»¥æ‰‹å‹•èª¿æ•´åƒè³½è€…
- çµ¦ä¸»è¾¦æ–¹æ›´å¤šæ§åˆ¶æ¬Š

---

## é¸æ‰‹åˆ†é…é‚è¼¯

### ç™¼å¸ƒè³½ç¨‹æ™‚æœƒåŸ·è¡Œ

```javascript
// CategoryPublisher.tsx
handlePublish() {
  if (canUseExistingMatches) {
    //  äººæ•¸ç¬¦åˆæ¨¡æ¿ç¯„åœ
    await assignPlayersToExistingMatches(
      tournamentId,
      categoryId,
      participants  // å·²ç¢ºèªçš„åƒè³½è€…
    )
  } else {
    // äººæ•¸ä¸ç¬¦åˆï¼Œæ¨è–¦å…¶ä»–æ¨¡æ¿æˆ–ä½¿ç”¨æ™ºèƒ½ç®—æ³•
  }
}
```

### assignPlayersToExistingMatches çš„æ­¥é©Ÿ

```javascript
1. è¼‰å…¥æ‰€æœ‰ Match
   â””â”€ ç¯©é¸è©²åˆ†é¡çš„ä½”ä½ç¬¦ Match

2. æ´—ç‰Œåƒè³½è€…ï¼ˆéš¨æ©Ÿåˆ†é…ï¼‰
   â””â”€ shuffleArray(participants)

3. æ‰¾å‡ºç¬¬ä¸€è¼ªæ¯”è³½
   â””â”€ filter: round === 1
   â””â”€ sort: æŒ‰ stage å’Œ matchOrder

4. åˆ†é…é¸æ‰‹
   â””â”€ Match #1: player1 vs player2
   â””â”€ Match #2: player3 vs player4
   â””â”€ ...
   â””â”€ isPlaceholder: false

5. æ‰¹æ¬¡å¯«å…¥ Firestore
   â””â”€ batch.commit()

6. è™•ç† BYE è‡ªå‹•æ™‰ç´š
   â””â”€ å¦‚æœæœ‰å¥‡æ•¸å€‹é¸æ‰‹
```

---

## è¨ºæ–·ï¼šç‚ºä»€éº¼é¸æ‰‹æ²’æœ‰å¡«å…¥ï¼Ÿ

### å·²ä¿®å¾©çš„ Bug

**Bugï¼š** æ’åºå‡½æ•¸ä¸­çš„è®Šæ•¸éŒ¯èª¤

```typescript
// éŒ¯èª¤
if (m.stage !== b.stage)  // m æœªå®šç¾©

//  ä¿®å¾©
if (a.stage !== b.stage)  // æ­£ç¢ºä½¿ç”¨ a å’Œ b
```

### æª¢æŸ¥ Console æ—¥èªŒ

ç¾åœ¨ç™¼å¸ƒè³½ç¨‹æ™‚æ‡‰è©²çœ‹åˆ°ï¼š

```javascript
ğŸ¯ [assignPlayersToExistingMatches] é–‹å§‹åˆ†é…é¸æ‰‹: {
  tournamentId: "xxx",
  categoryId: "yyy",
  participantsCount: 14
}

ğŸ“Š [assignPlayersToExistingMatches] è¼‰å…¥æ¯”è³½: {
  totalMatches: 15,
  categoryMatches: 15
}

ğŸ” [assignPlayersToExistingMatches] ä½”ä½ç¬¦ Match: {
  found: 15,
  matchIds: ["match-1", "match-2", ...]
}

ğŸ² [assignPlayersToExistingMatches] æ´—ç‰Œå®Œæˆ: {
  participants: ["å¼µä¸‰", "æå››", ...]
}

ğŸ“‹ [assignPlayersToExistingMatches] ç¬¬ä¸€è¼ªæ¯”è³½: {
  count: 8,  // 16å¼·çš„è©±æ˜¯8å ´
  rounds: [...]
}

ğŸ† [assignPlayersToExistingMatches] æ·˜æ±°è³½ç¬¬ä¸€è¼ª: {
  count: 8
}

  ğŸ‘¥ Match match-1: å¼µä¸‰ vs æå››
  ğŸ‘¥ Match match-2: ç‹äº” vs è¶™å…­
  ...

ğŸ’¾ [assignPlayersToExistingMatches] é–‹å§‹æ‰¹æ¬¡å¯«å…¥...
 [assignPlayersToExistingMatches] æ‰¹æ¬¡å¯«å…¥å®Œæˆ
ğŸš€ [assignPlayersToExistingMatches] è™•ç† BYE è‡ªå‹•æ™‰ç´š...
 [assignPlayersToExistingMatches] å®Œæˆï¼åˆ†é…äº† 14 ä½é¸æ‰‹
```

---

## å¸¸è¦‹å•é¡Œ

### Q1: æ‰¾ä¸åˆ°ä½”ä½ç¬¦ Match

**å¯èƒ½åŸå› ï¼š**

1. å»ºç«‹è³½äº‹æ™‚æ²’æœ‰é¸æ“‡æ¨¡æ¿
2. å»ºç«‹è³½äº‹æ™‚æ²’æœ‰é¸æ“‡è¦å‰‡
3. ä½”ä½ç¬¦ç”Ÿæˆå¤±æ•—

**æª¢æŸ¥ï¼š**

```javascript
// å»ºç«‹è³½äº‹æ™‚æ‡‰è©²çœ‹åˆ°
 [CreateTournament] Generated placeholder matches

// å¦‚æœçœ‹åˆ°
[CreateTournament] æœªç”Ÿæˆä½”ä½ç¬¦ Matchï¼ˆç¼ºå°‘æ¨¡æ¿æˆ–è¦å‰‡ï¼‰

// ä»£è¡¨æ²’æœ‰ç”Ÿæˆ
```

**è§£æ±ºï¼š**

- é‡æ–°å‰µå»ºè³½äº‹
- ç¢ºä¿é¸æ“‡äº†æ¨¡æ¿å’Œè¦å‰‡

### Q2: ä½”ä½ç¬¦æ‰¾åˆ°äº†ï¼Œä½†é¸æ‰‹æ²’å¡«å…¥

**å¯èƒ½åŸå› ï¼š**

1. æ‰¹æ¬¡å¯«å…¥å¤±æ•—
2. æ¬Šé™å•é¡Œ
3. è³‡æ–™æ ¼å¼éŒ¯èª¤

**æª¢æŸ¥ Console æ—¥èªŒï¼š**

```javascript
// æ‡‰è©²çœ‹åˆ°æ¯å€‹ Match çš„åˆ†é…
ğŸ‘¥ Match match-1: å¼µä¸‰ vs æå››

// å¦‚æœæ²’çœ‹åˆ°ï¼Œä»£è¡¨ for å¾ªç’°æ²’åŸ·è¡Œ
// æª¢æŸ¥ knockoutFirstRound.length æ˜¯å¦ç‚º 0
```

**é©—è­‰ Firestoreï¼š**

1. é€²å…¥ Firebase Console
2. æŸ¥çœ‹ matches é›†åˆ
3. æ‰¾åˆ°è©²åˆ†é¡çš„ Match
4. æª¢æŸ¥ `player1Id` æ˜¯å¦æœ‰å€¼
5. æª¢æŸ¥ `isPlaceholder` æ˜¯å¦è®Šç‚º false

### Q3: çœ‹åˆ°éŒ¯èª¤ä½†ä¸æ¸…æ¥šåŸå› 

**åŸ·è¡Œé€™äº›æª¢æŸ¥ï¼š**

```javascript
// 1. æª¢æŸ¥åƒè³½è€…æ•¸é‡
console æ‡‰è©²é¡¯ç¤ºï¼š
participantsCount: X  // å¿…é ˆ > 0

// 2. æª¢æŸ¥æ‰¾åˆ°çš„ä½”ä½ç¬¦
found: X  // å¿…é ˆ > 0

// 3. æª¢æŸ¥ç¬¬ä¸€è¼ªæ¯”è³½
count: X  // å¿…é ˆ > 0

// 4. æª¢æŸ¥æ‰¹æ¬¡å¯«å…¥
æ‡‰è©²çœ‹åˆ°ï¼š
 [assignPlayersToExistingMatches] æ‰¹æ¬¡å¯«å…¥å®Œæˆ

// å¦‚æœæ²’çœ‹åˆ°ï¼Œå¯èƒ½æ˜¯ï¼š
- Firestore æ¬Šé™å•é¡Œ
- æ‰¹æ¬¡å¯«å…¥æ•¸é‡è¶…éé™åˆ¶ï¼ˆ500å€‹ï¼‰
- è³‡æ–™æ ¼å¼éŒ¯èª¤
```

---

## æ¸¬è©¦ç”¨å®Œæ•´æµç¨‹

### æ¸¬è©¦ï¼š16 å¼·æ·˜æ±°è³½ï¼ˆ14 äººå ±åï¼‰

```
1. å»ºç«‹è³½äº‹
   - é¸æ“‡æ¨¡æ¿ï¼ško_16 (12-16äºº)
   - ç”Ÿæˆ 15 å€‹ä½”ä½ç¬¦ Match
   - Console:  Generated placeholder matches

2. é–‹æ”¾å ±å
   - ä¸»è¾¦æ–¹åœ¨ã€Œè³½äº‹è³‡è¨Šã€Tab é»æ“Šã€Œé–‹æ”¾å ±åã€
   - ç‹€æ…‹ï¼šDRAFT â†’ REGISTRATION_OPEN

3. é¸æ‰‹å ±åï¼ˆå‡è¨­ 14 äººï¼‰
   - é¸æ‰‹é€ä¸€å ±å
   - ä¸»è¾¦æ–¹åœ¨ã€Œé¸æ‰‹ç®¡ç†ã€Tab é€ä¸€æ‰¹å‡†
   - currentParticipants: 14

4. æˆªæ­¢å ±å
   - ä¸»è¾¦æ–¹åœ¨ã€Œè³½äº‹è³‡è¨Šã€Tab é»æ“Šã€Œæˆªæ­¢å ±åã€
   - ç‹€æ…‹ï¼šREGISTRATION_OPEN â†’ REGISTRATION_CLOSED
   - æ³¨æ„ï¼šæ­¤æ™‚é‚„æ²’ç™¼å¸ƒè³½ç¨‹ï¼

5. é€²å…¥ã€Œè³½ç¨‹ç®¡ç†ã€Tab
   - çœ‹åˆ°ï¼š äººæ•¸ç¬¦åˆåŸå®šæ¨¡æ¿ï¼ˆ14äººåœ¨12-16ç¯„åœå…§ï¼‰
   - é¡¯ç¤ºåƒè³½è€…ï¼š14
   - é¡¯ç¤ºå ´åœ°ï¼šX

6. é»æ“Šã€Œç™¼å¸ƒè³½ç¨‹ã€â­
   Console æ‡‰è©²é¡¯ç¤ºï¼š
   ğŸ¯ [assignPlayersToExistingMatches] é–‹å§‹åˆ†é…é¸æ‰‹
   ğŸ“Š è¼‰å…¥æ¯”è³½: { totalMatches: 15 }
   ğŸ” ä½”ä½ç¬¦ Match: { found: 15 }
   ğŸ² æ´—ç‰Œå®Œæˆ
   ğŸ“‹ ç¬¬ä¸€è¼ªæ¯”è³½: { count: 8 }
   ğŸ† æ·˜æ±°è³½ç¬¬ä¸€è¼ª: { count: 8 }
     ğŸ‘¥ Match match-1: å¼µä¸‰ vs æå››
     ğŸ‘¥ Match match-2: ç‹äº” vs è¶™å…­
     ...
   ğŸ’¾ é–‹å§‹æ‰¹æ¬¡å¯«å…¥...
    æ‰¹æ¬¡å¯«å…¥å®Œæˆ
   ğŸš€ è™•ç† BYE è‡ªå‹•æ™‰ç´š...
    å®Œæˆï¼åˆ†é…äº† 14 ä½é¸æ‰‹

7. é©—è­‰çµæœ
   - é‡æ–°æ•´ç† CategoryDetail
   - å°é™£åœ– Tab æ‡‰è©²é¡¯ç¤ºçœŸå¯¦é¸æ‰‹åç¨±
   - ä¸å†é¡¯ç¤ºã€Œå¾…å®šã€
   - ä¸å†é¡¯ç¤ºã€Œé è¦½ã€æ¨™ç±¤
   - ç‹€æ…‹è®Šç‚ºã€Œå·²æ’ç¨‹ã€æˆ–ã€Œå¾…é–‹å§‹ã€
```

---

## å¦‚æœé¸æ‰‹ä»ç„¶æ²’æœ‰å¡«å…¥

### æª¢æŸ¥æ¸…å–®

1. **æª¢æŸ¥åƒè³½è€…æ•¸é‡**

   ```javascript
   // åœ¨ã€Œè³½ç¨‹ç®¡ç†ã€Tab æ‡‰è©²é¡¯ç¤º
   åƒè³½è€…: 14; // å¿…é ˆ > 0
   ```

   å¦‚æœæ˜¯ 0ï¼Œä»£è¡¨æ²’æœ‰å·²ç¢ºèªçš„åƒè³½è€…ã€‚

2. **æª¢æŸ¥ Console æ—¥èªŒ**

   - æ‡‰è©²çœ‹åˆ°å®Œæ•´çš„åˆ†é…æµç¨‹æ—¥èªŒ
   - å¦‚æœä¸­é€”åœæ­¢ï¼ŒæŸ¥çœ‹æœ€å¾Œä¸€æ¢è¨Šæ¯

3. **æª¢æŸ¥ Firebase Console**

   - é€²å…¥ matches é›†åˆ
   - æ‰¾åˆ°è©²åˆ†é¡çš„ Match
   - æª¢æŸ¥ `player1Id` å’Œ `player1Name`
   - æª¢æŸ¥ `isPlaceholder` æ˜¯å¦è®Šç‚º false

4. **æª¢æŸ¥ CategoryDetail çš„æŸ¥è©¢**
   - CategoryDetail æœƒè¼‰å…¥æ‰€æœ‰ Matchï¼ˆåŒ…å«ä½”ä½ç¬¦ï¼‰
   - å¦‚æœ isPlaceholder é‚„æ˜¯ trueï¼Œä»£è¡¨åˆ†é…æ²’æœ‰åŸ·è¡Œ
   - å¦‚æœ isPlaceholder æ˜¯ false ä½†é‚„é¡¯ç¤ºã€Œå¾…å®šã€ï¼Œä»£è¡¨ UI å•é¡Œ

---

## ç·Šæ€¥ä¿®å¾©æ–¹æ¡ˆ

å¦‚æœé¸æ‰‹åˆ†é…æŒçºŒå¤±æ•—ï¼š

### æ–¹æ¡ˆ Aï¼šä½¿ç”¨èˆŠçš„ç”Ÿæˆæ–¹å¼ï¼ˆä¸ç”¨ä½”ä½ç¬¦ï¼‰

åœ¨ CategoryPublisher.tsx ä¸­ï¼Œç³»çµ±æœƒè‡ªå‹•é™ç´šç‚ºæ™ºèƒ½ç®—æ³•ï¼š

```javascript
// å¦‚æœæ‰¾ä¸åˆ°ä½”ä½ç¬¦æˆ–åˆ†é…å¤±æ•—
// ç³»çµ±æœƒä½¿ç”¨ï¼š
await generateKnockoutOnly(); // é‡æ–°ç”Ÿæˆæ‰€æœ‰ Match
```

é€™ä¸æœƒä½¿ç”¨ä½”ä½ç¬¦ï¼Œä½†åŠŸèƒ½ç›¸åŒã€‚

### æ–¹æ¡ˆ Bï¼šæª¢æŸ¥ Firestore æ¬Šé™

```bash
# æª¢æŸ¥ matches é›†åˆçš„ update æ¬Šé™
firebase firestore:rules:get | grep -A 10 "matches"
```

ç¢ºä¿æœ‰ï¼š

```javascript
allow update: if isAuthenticated() &&
              (resource.data.scorerId == request.auth.uid ||
               get(/databases/.../tournaments/...).data.organizerId == request.auth.uid ||
               getUserRole() == 'scorer');
```

---

## æˆåŠŸçš„æ¨™èªŒ

### åœ¨ Console

```javascript
 [assignPlayersToExistingMatches] å®Œæˆï¼åˆ†é…äº† 14 ä½é¸æ‰‹
```

### åœ¨ CategoryDetail

```
å°é™£åœ– Tab:
  Match #1: å¼µä¸‰ vs æå›› [å·²æ’ç¨‹]
  Match #2: ç‹äº” vs è¶™å…­ [å·²æ’ç¨‹]
  ...
  ï¼ˆä¸å†é¡¯ç¤ºã€Œå¾…å®šã€å’Œã€Œé è¦½ã€ï¼‰
```

### åœ¨ Firebase Console

```javascript
matches/{matchId} {
  isPlaceholder: false,      //  è®Šç‚º false
  player1Id: "uid123",       //  æœ‰çœŸå¯¦ ID
  player1Name: "å¼µä¸‰",       //  æœ‰çœŸå¯¦åå­—
  player2Id: "uid456",
  player2Name: "æå››",
  status: "SCHEDULED"        //  è®Šç‚º SCHEDULED
}
```

---

## ç«‹å³æ“ä½œå»ºè­°

1. **æ¸…é™¤å¿«å–ä¸¦é‡æ–°æ•´ç†**

   ```
   Mac: Cmd + Shift + R
   Windows: Ctrl + Shift + R
   ```

2. **é‡æ–°æ¸¬è©¦ç™¼å¸ƒæµç¨‹**

   - é€²å…¥ã€Œè³½ç¨‹ç®¡ç†ã€Tab
   - é»æ“Šã€Œç™¼å¸ƒè³½ç¨‹ã€
   - è§€å¯Ÿ Console çš„å®Œæ•´æ—¥èªŒ

3. **å¦‚æœçœ‹åˆ°éŒ¯èª¤**

   - è¤‡è£½å®Œæ•´çš„ Console æ—¥èªŒ
   - æª¢æŸ¥æ˜¯å“ªä¸€æ­¥å¤±æ•—

4. **å¦‚æœæˆåŠŸä½† UI æ²’æ›´æ–°**
   - é‡æ–°æ•´ç† CategoryDetail é é¢
   - æª¢æŸ¥ Firestore ä¸­çš„è³‡æ–™æ˜¯å¦æ­£ç¢ºæ›´æ–°

---

## ç‹€æ…‹æµè½‰åœ–

```
DRAFT
  â†“ (é–‹æ”¾å ±å)
REGISTRATION_OPEN
  â†“ (æˆªæ­¢å ±å) ä¸æœƒè‡ªå‹•ç™¼å¸ƒ
REGISTRATION_CLOSED
  â†“ (ç™¼å¸ƒè³½ç¨‹) â­ æ‰‹å‹•è§¸ç™¼
ONGOING
  â†“ (å®Œæˆæ¯”è³½)
COMPLETED
```

**é—œéµï¼š** `REGISTRATION_CLOSED` â†’ `ONGOING` çš„è½‰æ›åªæœƒåœ¨ã€Œç™¼å¸ƒè³½ç¨‹ã€æ™‚ç™¼ç”Ÿï¼Œä¸æ˜¯æˆªæ­¢å ±åæ™‚è‡ªå‹•ç™¼ç”Ÿã€‚
